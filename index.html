<!DOCTYPE html>
<html>
<head>
<title>vgmstream-web</title>
<style>
body{
	transition: background-color 0.5s;
	background-color: #fff;
	font-family: sans-serif;
	font-size: 20px;
}
</style>
</head>
<body>
<h2>vgmstream-web</h2>
<div id="hint">Drag and drop an audio stream file here...</div>
<audio id="audio" controls style="display:none"></audio>
<script src="vgmstream-cli.js"></script>
<script>
var audio = document.getElementById("audio")
var hint = document.getElementById("hint")

async function convertFile(file){
	var filename = file.name
	var output = filename + ".wav"
	var data = new Uint8Array(await file.arrayBuffer())
	var stream = FS.open(filename, "w+")
	FS.write(stream, data, 0, data.length, 0)
	FS.close(stream)
	try{
		callMain([filename])
	}catch(e){
		return {error: {
			type: "wasm",
			stack: e
		}}
	}finally{
		FS.unlink(filename)
	}
	try{
		var wav = FS.open(output, "r")
	}catch(e){
		return {error: {
			type: "unsupported",
			stack: e
		}}
	}
	var wavdata = new Uint8Array(wav.node.usedBytes)
	FS.read(wav, wavdata, 0, wav.node.usedBytes, 0)
	FS.close(wav)
	FS.unlink(output)
	return {url: URL.createObjectURL(new Blob([wavdata]))}
}

document.addEventListener("dragover", event => {
	event.preventDefault()
	event.dataTransfer.dropEffect = "copy"
	document.body.style.backgroundColor = "#ccc"
})
document.addEventListener("dragleave", () => {
	document.body.style.backgroundColor = "#fff"
})
document.addEventListener("drop", event => {
	document.body.style.backgroundColor = "#fff"
	event.preventDefault()
	var file = event.dataTransfer.files[0]
	if(file){
		convertFile(file).then(response => {
			if(response.error){
				if(response.error.type === "wasm"){
					alert("Segmentation fault (core dumped)")
				}else{
					alert("Could not convert file")
				}
			}else if(response.url){
				if(audio.src){
					URL.revokeObjectURL(audio.src)
				}
				audio.src = response.url
				audio.style.display = ""
				hint.style.display = "none"
			}
		})
	}
})
</script>
</body>
</html>
